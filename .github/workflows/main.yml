name: Raphael Kernel Build (No Signature + KernelSU Stubs)

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            bc bison build-essential ccache curl flex g++-multilib gcc-multilib \
            git gnupg gperf libncurses5-dev libssl-dev libelf-dev \
            lzop python3 rsync unzip zip zstd

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1
        with:
          max-size: 2G

      # ---- Disable KernelSU from Kconfig ----
      - name: Disable KernelSU Kconfig include
        run: |
          sed -i 's|source "drivers/kernelsu/Kconfig"|# source "drivers/kernelsu/Kconfig"|g' drivers/Kconfig || true

      # ---- Add KernelSU stub functions to satisfy linker ----
      - name: Add KernelSU stub functions
        run: |
          cat << 'EOF' > kernel/ksu_stub.c
          #include <linux/types.h>

          int ksu_handle_faccessat(void *a, void *b, void *c, void *d) { return 0; }
          int ksu_handle_vfs_read(void *a, void *b, void *c, void *d) { return 0; }
          int ksu_handle_stat(void *a, void *b, void *c) { return 0; }
          int ksu_handle_execveat(void *a, void *b, void *c, void *d, void *e) { return 0; }
          int ksu_handle_input_handle_event(void *a, void *b, void *c) { return 0; }
          EOF

          echo "obj-y += ksu_stub.o" >> kernel/Makefile

      # ---- Disable module signature verification ----
      - name: Disable module signature in defconfig
        run: |
          for f in arch/arm64/configs/raphael_defconfig arch/arm64/configs/raphael_user_defconfig; do
            if [ -f "$f" ]; then
              sed -i '/CONFIG_MODULE_SIG/d' $f
              sed -i '/CONFIG_MODULE_SIG_FORCE/d' $f
              sed -i '/CONFIG_MODULE_SIG_ALL/d' $f
              echo "# CONFIG_MODULE_SIG is not set" >> $f
              echo "# CONFIG_MODULE_SIG_FORCE is not set" >> $f
              echo "# CONFIG_MODULE_SIG_ALL is not set" >> $f
            fi
          done

      # ---- Clone Proton Clang toolchain ----
      - name: Clone Proton Clang
        run: |
          git clone --depth=1 https://github.com/kdrag0n/proton-clang.git clang

      - name: Export build environment
        run: |
          echo "ARCH=arm64" >> $GITHUB_ENV
          echo "SUBARCH=arm64" >> $GITHUB_ENV
          echo "PATH=$PWD/clang/bin:$PATH" >> $GITHUB_ENV
          echo "CC=clang" >> $GITHUB_ENV
          echo "CROSS_COMPILE=aarch64-linux-gnu-" >> $GITHUB_ENV
          echo "CROSS_COMPILE_ARM32=arm-linux-gnueabi-" >> $GITHUB_ENV
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV

      # ---- Make defconfig ----
      - name: Make raphael defconfig
        run: |
          make O=out raphael_defconfig

      # ---- Force disable signature in final config ----
      - name: Force disable signature in final config
        run: |
          chmod +x scripts/config || true
          scripts/config --file out/.config \
            -d MODULE_SIG \
            -d MODULE_SIG_FORCE \
            -d MODULE_SIG_ALL
          make O=out olddefconfig

      - name: Verify signature options
        run: |
          grep -E "MODULE_SIG" out/.config || true

      # ---- Build kernel ----
      - name: Build kernel
        run: |
          make -j$(nproc) O=out \
            CC=clang \
            CROSS_COMPILE=aarch64-linux-gnu- \
            CROSS_COMPILE_ARM32=arm-linux-gnueabi-

      - name: Upload kernel image
        uses: actions/upload-artifact@v4
        with:
          name: raphael-kernel
          path: |
            out/arch/arm64/boot/Image*
            out/arch/arm64/boot/dts/qcom/*.dtb
